# Architecture

**Analysis Date:** 2026-02-02

## Pattern Overview

**Overall:** Modular Configuration-Driven Architecture

**Key Characteristics:**
- Hierarchical configuration file sourcing with base + override pattern
- Separation of concerns across functional domains (env, general, rules, keybinds, execs)
- Shell script layer for dynamic behavior and fallback functionality
- Plugin-based extensibility (Hyprland plugins, Quickshell integration)
- Environment-based configuration with conditional execution paths

## Layers

**Configuration Layer:**
- Purpose: Define and manage Hyprland compositor settings
- Location: `/home/sammy/.config/hypr/hyprland/` and `/home/sammy/.config/hypr/custom/`
- Contains: Environment variables, general settings, window rules, layer rules, keybindings, execution hooks
- Depends on: Hyprland compositor, Quickshell, various system services
- Used by: Hyprland at startup, runtime configuration reload

**Script Layer:**
- Purpose: Provide dynamic behavior, fallbacks, and utility functions
- Location: `/home/sammy/.config/hypr/hyprland/scripts/` and `/home/sammy/.config/hypr/custom/scripts/`
- Contains: Shell scripts for workspace management, application launching, media controls, AI integration
- Depends on: System utilities (hyprctl, jq, playerctl, brightnessctl, etc.)
- Used by: Keybindings via `exec` and `global` dispatches, startup hooks

**Display Configuration Layer:**
- Purpose: Manage monitor and workspace layouts
- Location: `/home/sammy/.config/hypr/monitors.conf` and `/home/sammy/.config/hypr/workspaces.conf`
- Contains: Monitor configurations, workspace-to-monitor assignments
- Depends on: nwg-displays tool (auto-generated)
- Used by: Hyprland display initialization and workspace management

**Customization Layer:**
- Purpose: Allow user overrides without modifying defaults
- Location: `/home/sammy/.config/hypr/custom/`
- Contains: User-specific env, general, rules, keybinds, and scripts
- Depends on: Base configuration files
- Used by: Main hyprland.conf to override defaults

## Data Flow

**Startup Sequence:**

1. Hyprland loads `/home/sammy/.config/hypr/hyprland.conf` (main entry point)
2. Main config sources base configuration files in order:
   - `hyprland/env.conf` - Environment variables (Wayland, themes, applications)
   - `hyprland/execs.conf` - Startup services (Quickshell, audio, clipboard, keyring)
   - `hyprland/general.conf` - Compositor settings (gaps, animations, gestures, input)
   - `hyprland/rules.conf` - Window and layer rules
   - `hyprland/colors.conf` - Color definitions
   - `hyprland/keybinds.conf` - Keybinding definitions
3. Custom overrides are sourced:
   - `custom/env.conf` - User environment overrides
   - `custom/execs.conf` - User startup hooks
   - `custom/general.conf` - User general settings
   - `custom/rules.conf` - User window/layer rules
   - `custom/keybinds.conf` - User keybindings
4. Display configuration loaded:
   - `monitors.conf` - Monitor definitions (auto-generated by nwg-displays)
   - `workspaces.conf` - Workspace assignments (auto-generated by nwg-displays)

**Keybinding Execution Flow:**

1. User presses key combination
2. Hyprland matches keybinding in `hyprland/keybinds.conf`
3. Keybinding triggers one of:
   - Direct `hyprctl dispatch` call (e.g., `movefocus l`)
   - IPC call to Quickshell (e.g., `qs -c $qsConfig ipc call TEST_ALIVE`)
   - Shell script execution (e.g., `exec ~/.config/hypr/hyprland/scripts/zoom.sh`)
4. Fallback chain: If Quickshell unavailable, fallback to script or system command

**Service Initialization:**

1. Startup services execute via `exec-once` in `hyprland/execs.conf`:
   - Geoclue agent (location services)
   - Quickshell (UI shell, bars, panels)
   - Wallpaper restoration
   - Core services (keyring, idle daemon, dbus)
   - Audio effects
   - Clipboard history daemon

**State Management:**
- Hyprland maintains compositor state (window layout, workspace, focus)
- Quickshell maintains UI state (bars, sidebars, overlays)
- System services maintain persistent state (clipboard history via cliphist, desktop colors)
- Display state auto-saved by nwg-displays

## Key Abstractions

**Configuration Profiles:**
- Purpose: Organize related settings by function
- Examples: `env.conf`, `general.conf`, `rules.conf`, `keybinds.conf`, `execs.conf`
- Pattern: Each profile file handles a single concern; sourced in dependency order

**Script Utilities:**
- Purpose: Encapsulate complex logic and provide reusable functionality
- Examples: `workspace_action.sh`, `launch_first_available.sh`, `zoom.sh`
- Pattern: Each script handles a specific domain; takes parameters for flexibility

**Rule Sets:**
- Purpose: Define behavior for specific windows or layers
- Examples: Floating dialogs, tiling behavior, blur effects, animations
- Pattern: Matching criteria (class, title, namespace) mapped to rule actions

**Keybinding Maps:**
- Purpose: Organize keybindings by functional domain
- Examples: Shell commands, window management, utilities, media, apps, session
- Pattern: Comments divide sections; fallback bindings provide compatibility

## Entry Points

**Main Configuration:**
- Location: `/home/sammy/.config/hypr/hyprland.conf`
- Triggers: Hyprland startup and reload (via `Ctrl+Super+R`)
- Responsibilities: Load all configuration files in correct order, set variables, initialize services

**Keybinding System:**
- Location: `/home/sammy/.config/hypr/hyprland/keybinds.conf`
- Triggers: User keyboard/mouse input
- Responsibilities: Route input to Quickshell IPC, scripts, or native dispatchers

**Startup Services:**
- Location: `/home/sammy/.config/hypr/hyprland/execs.conf`
- Triggers: Session start and reload
- Responsibilities: Initialize background services, restore state, configure system

**Script Entry Points:**
- `workspace_action.sh`: Maps workspace numbers to actual workspace IDs accounting for monitor grouping
- `launch_first_available.sh`: Try multiple app commands in order until one succeeds
- `zoom.sh`: Control cursor zoom with clamping between 1.0-3.0

## Error Handling

**Strategy:** Graceful degradation with fallback chains

**Patterns:**
- Multiple dispatch paths for critical functions (e.g., Quickshell primary, system command fallback)
- `launch_first_available.sh` tries commands in sequence; first successful one runs
- Invalid keybindings logged but non-blocking
- Missing scripts/executables result in failed keybinding but don't crash compositor

## Cross-Cutting Concerns

**Logging:**
- Keybinding comments mark hidden/debug entries with `# [hidden]`
- Startup services redirected to systemd journal
- Script output available via hyprctl or IPC

**Validation:**
- Workspace IDs validated in `workspace_action.sh` (accounts for multi-monitor layout)
- Zoom values clamped in `zoom.sh` (1.0-3.0 range)
- Keybinding syntax validated by Hyprland parser

**Configuration Composition:**
- Base files provide sensible defaults
- Custom files override selectively
- Order-dependent sourcing ensures predictable behavior

---

*Architecture analysis: 2026-02-02*
