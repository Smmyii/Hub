---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - ~/.config/quickshell/ii/modules/ii/stickyNotes/StickyNotes.qml
  - ~/.config/quickshell/ii/modules/ii/stickyNotes/StickyNoteWindow.qml
  - ~/.config/hypr/custom/keybinds.conf
autonomous: false

must_haves:
  truths:
    - "User can see a note widget positioned on the layer shell"
    - "User can toggle note visibility via Super+Shift+G keybind"
    - "Super+G overlay still functions correctly (no regression)"
    - "Clicking the note focuses it (can type immediately)"
    - "Note hides when an app goes fullscreen"
  artifacts:
    - path: "~/.config/quickshell/ii/modules/ii/stickyNotes/StickyNoteWindow.qml"
      provides: "PanelWindow with layer shell positioning"
      min_lines: 80
      contains: "WlrLayershell"
    - path: "~/.config/quickshell/ii/modules/ii/stickyNotes/StickyNotes.qml"
      provides: "Complete module with IPC, shortcuts, and window instantiation"
      min_lines: 60
      exports: ["IpcHandler", "GlobalShortcut"]
    - path: "~/.config/hypr/custom/keybinds.conf"
      provides: "Super+Shift+G keybind for sticky notes"
      contains: "stickyNotesToggle"
  key_links:
    - from: "keybinds.conf"
      to: "GlobalShortcut"
      via: "quickshell:stickyNotesToggle"
      pattern: "global.*quickshell:stickyNotesToggle"
    - from: "StickyNotes.qml"
      to: "StickyNotesService"
      via: "IPC toggle function"
      pattern: "function toggle"
    - from: "StickyNoteWindow.qml"
      to: "WlrLayershell"
      via: "layer shell positioning"
      pattern: "WlrLayershell\\.layer.*WlrLayer\\.Overlay"
    - from: "StickyNoteWindow.qml"
      to: "StickyNoteContent"
      via: "content component"
      pattern: "StickyNoteContent"
---

<objective>
Complete the sticky notes module with layer shell windows, IPC handlers, and keybind integration.

Purpose: Wire everything together so the user can toggle sticky notes via Super+Shift+G, see notes on the layer shell, type in them immediately on click, and have notes auto-hide during fullscreen apps.

Output: Fully functional foundation - note appears on screen, responds to keybind, accepts text input, hides during fullscreen.
</objective>

<execution_context>
@/home/sammy/.claude/get-shit-done/workflows/execute-plan.md
@/home/sammy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/sammy/.config/hypr/.planning/PROJECT.md
@/home/sammy/.config/hypr/.planning/ROADMAP.md
@/home/sammy/.config/hypr/.planning/phases/01-foundation/01-RESEARCH.md

# Prior plan summary (after Plan 01 completes)
@/home/sammy/.config/hypr/.planning/phases/01-foundation/01-01-SUMMARY.md

# Reference patterns
@/home/sammy/.config/quickshell/ii/modules/ii/overlay/Overlay.qml
@/home/sammy/.config/quickshell/ii/modules/ii/background/Background.qml
@/home/sammy/.config/hypr/hyprland/keybinds.conf
@/home/sammy/.config/hypr/custom/keybinds.conf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StickyNoteWindow with layer shell positioning</name>
  <files>
    ~/.config/quickshell/ii/modules/ii/stickyNotes/StickyNoteWindow.qml
  </files>
  <action>
1. Create StickyNoteWindow.qml as a PanelWindow-based component:
   - Imports: QtQuick, Quickshell, Quickshell.Wayland, Quickshell.Hyprland, qs.modules.common

2. Root component: PanelWindow with properties:
   - noteId (string) - identifies which note this window represents
   - noteData (var) - bound to the note object from service
   - Required WlrLayershell configuration:
     ```qml
     exclusionMode: ExclusionMode.Ignore
     WlrLayershell.namespace: "quickshell:stickyNote"
     WlrLayershell.layer: WlrLayer.Overlay
     WlrLayershell.keyboardFocus: WlrKeyboardFocus.OnDemand
     ```
   - visible: bound to noteData.visible AND !isFullscreen (see fullscreen detection below)
   - color: "transparent"
   - x, y, width, height: bound to noteData properties

3. Fullscreen detection (from Background.qml pattern):
   ```qml
   property bool hideWhenFullscreen: true
   property list<HyprlandWorkspace> workspacesForMonitor:
       Hyprland.workspaces.values.filter(workspace =>
           workspace.monitor && workspace.monitor.name == screen.name)
   property var activeWorkspaceWithFullscreen:
       workspacesForMonitor.filter(workspace =>
           ((workspace.toplevels.values.filter(window =>
               window.wayland?.fullscreen)[0] != undefined) && workspace.active))[0]
   property bool isFullscreen: activeWorkspaceWithFullscreen != undefined && hideWhenFullscreen
   ```

4. Content: StickyNoteContent component:
   ```qml
   StickyNoteContent {
       id: noteContent
       anchors.fill: parent
       noteId: root.noteId
       content: noteData.content
       onContentChanged: (newContent) => {
           StickyNotesService.updateNote(noteId, { content: newContent })
       }
   }
   ```

5. Focus handling - when window becomes visible or is clicked:
   ```qml
   onVisibleChanged: {
       if (visible) {
           Qt.callLater(noteContent.focusAtEnd)
       }
   }
   ```

6. Click-to-focus via MouseArea covering the window:
   ```qml
   MouseArea {
       anchors.fill: parent
       propagateComposedEvents: true
       onPressed: (mouse) => {
           StickyNotesService.updateNote(noteId, { lastActive: Date.now() })
           noteContent.focusAtEnd()
           mouse.accepted = false  // Let events propagate to text area
       }
   }
   ```

7. Visual styling (match ii/ aesthetic):
   - Use Rectangle background with Appearance.colors.colLayer1
   - Border: 1px Appearance.colors.colLayer1Outline
   - Rounded corners: Appearance.rounding.normal
   - Drop shadow using StyledDropShadow or Qt5Compat.GraphicalEffects.DropShadow
  </action>
  <verify>
    - File exists at ~/.config/quickshell/ii/modules/ii/stickyNotes/StickyNoteWindow.qml
    - Contains WlrLayershell.layer: WlrLayer.Overlay
    - Contains WlrKeyboardFocus.OnDemand
    - Contains fullscreen detection logic
    - Contains StickyNoteContent child
  </verify>
  <done>
    - StickyNoteWindow.qml exists with layer shell configuration
    - Window hides during fullscreen apps
    - Clicking focuses the text area immediately
    - Visual styling matches ii/ aesthetic
  </done>
</task>

<task type="auto">
  <name>Task 2: Complete StickyNotes module with IPC and shortcuts</name>
  <files>
    ~/.config/quickshell/ii/modules/ii/stickyNotes/StickyNotes.qml
  </files>
  <action>
1. Update StickyNotes.qml to add window instantiation:
   - Use Repeater with model: StickyNotesService.notes
   - Delegate: Loader loading StickyNoteWindow.qml
   ```qml
   Repeater {
       model: StickyNotesService.notes
       delegate: Loader {
           required property var modelData
           active: true
           sourceComponent: StickyNoteWindow {
               noteId: modelData.id
               noteData: modelData
           }
       }
   }
   ```

2. Add IpcHandler following existing pattern:
   ```qml
   IpcHandler {
       target: "stickyNotes"

       function toggle(): void {
           StickyNotesService.toggleLastActive()
       }

       function create(): void {
           StickyNotesService.createNote()
       }

       function showAll(): void {
           StickyNotesService.showAll()
       }

       function hideAll(): void {
           StickyNotesService.hideAll()
       }
   }
   ```

3. Add GlobalShortcut for keybind:
   ```qml
   GlobalShortcut {
       name: "stickyNotesToggle"
       description: "Toggle sticky notes"

       onPressed: {
           StickyNotesService.toggleLastActive()
       }
   }
   ```

4. Add error notification function (called by service on errors):
   ```qml
   function notifyError(message: string): void {
       Quickshell.execDetached(["notify-send",
           "Sticky Notes",
           "Error: " + message,
           "-a", "Quickshell"
       ])
   }
   ```

5. Update StickyNotesService.qml to add toggleLastActive() if not already present:
   - Finds note with most recent lastActive timestamp
   - Toggles its visible property
   - If no notes exist, creates one
  </action>
  <verify>
    - StickyNotes.qml has IpcHandler with target "stickyNotes"
    - Has GlobalShortcut with name "stickyNotesToggle"
    - Has Repeater creating StickyNoteWindow instances
    - IPC test: `qs -c ii ipc call stickyNotes toggle` (after Quickshell restart)
  </verify>
  <done>
    - StickyNotes.qml complete with IPC handlers and GlobalShortcut
    - Module creates windows from StickyNotesService.notes
    - Toggle, create, showAll, hideAll functions accessible via IPC
  </done>
</task>

<task type="auto">
  <name>Task 3: Add keybind and register module</name>
  <files>
    ~/.config/hypr/custom/keybinds.conf
  </files>
  <action>
1. Add sticky notes keybind to custom/keybinds.conf (update-resilient location):
   ```conf
   ##! Sticky Notes
   bind = Super+Shift, G, global, quickshell:stickyNotesToggle # Toggle sticky note
   bind = Super+Shift, G, exec, qs -c ii ipc call stickyNotes toggle # [hidden] Toggle sticky note (fallback)
   ```

   Note: Follow the pattern from keybinds.conf where binds have both a GlobalShortcut and an exec fallback.

2. Verify module is loaded by Quickshell:
   - Check if there's a modules loader file that needs updating
   - Look at how other modules under modules/ii/ are registered
   - If needed, add import to the appropriate shell.qml or similar entry point

3. If module registration is needed, identify the correct file:
   - Check ~/.config/quickshell/ii/ for main entry point
   - Look for where Overlay and other modules are imported
   - Add StickyNotes import following the same pattern
  </action>
  <verify>
    - custom/keybinds.conf contains Super+Shift+G binding
    - Binding references quickshell:stickyNotesToggle
    - Module is discoverable by Quickshell (check registration if needed)
  </verify>
  <done>
    - Keybind added to custom/keybinds.conf for update resilience
    - Both GlobalShortcut and fallback exec patterns in place
    - Module properly registered with Quickshell
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete sticky notes foundation:
    - Layer shell positioned note window
    - IPC interface (toggle, create, showAll, hideAll)
    - Super+Shift+G keybind
    - Fullscreen auto-hide
    - Click-to-focus text input
  </what-built>
  <how-to-verify>
    1. Restart Quickshell: `killall qs quickshell; qs -c ii &`
    2. Press Super+Shift+G - a sticky note should appear
    3. Click the note - cursor should be in text area, ready to type
    4. Type some text - it should be accepted
    5. Press Super+Shift+G again - note should hide
    6. Press Super+Shift+G again - note should show with your text still there
    7. Open any app and make it fullscreen (Super+F) - note should hide
    8. Exit fullscreen - note should reappear
    9. Press Super+G - overlay should still work (no regression)
    10. Test IPC: `qs -c ii ipc call stickyNotes create` - should create a second note
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe specific issues</resume-signal>
</task>

</tasks>

<verification>
All phase success criteria must be true:
1. User can see a note widget positioned on the layer shell (not floating randomly)
2. User can toggle note visibility via keybind (Super+Shift+G works)
3. Super+G overlay still functions correctly (no regression)
4. Clicking note focuses it immediately (can type right away)
5. Note hides when apps go fullscreen
</verification>

<success_criteria>
- Super+Shift+G toggles sticky note visibility
- Super+G still toggles overlay (unchanged behavior)
- Note appears on layer shell with proper positioning
- Clicking note immediately allows typing
- Note auto-hides during fullscreen apps
- IPC commands work: toggle, create, showAll, hideAll
- Data persists at ~/.local/share/quickshell/sticky-notes.json
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
